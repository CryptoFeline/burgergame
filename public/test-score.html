<!DOCTYPE html>
<html>
<head>
    <title>Telegram Games Score Submission Test</title>
    <!-- Load official Telegram Games JS -->
    <script src="https://telegram.org/js/games.js"></script>
</head>
<body>
    <h1>üçî Score Submission Diagnostics</h1>
    <p>Testing Telegram Games API score submission...</p>
    
    <div id="status"></div>
    
    <button onclick="testOfficialAPI()">Test Official Games.js</button>
    <button onclick="testScoreSubmission(42)">Test Score 42</button>
    <button onclick="testScoreSubmission(100)">Test Score 100</button>
    
    <div id="logs" style="margin-top: 20px; font-family: monospace; background: #f0f0f0; padding: 10px; white-space: pre-wrap;"></div>
    
    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `${timestamp}: ${message}\n`;
            console.log(message);
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        function testOfficialAPI() {
            log('=== Testing Official Telegram Games API ===');
            
            // Check if official API loaded
            log('window.TelegramGameProxy exists: ' + (typeof window.TelegramGameProxy !== 'undefined'));
            
            if (typeof window.TelegramGameProxy !== 'undefined') {
                log('TelegramGameProxy methods:');
                Object.getOwnPropertyNames(window.TelegramGameProxy).forEach(prop => {
                    log(`  - ${prop}: ${typeof window.TelegramGameProxy[prop]}`);
                });
                
                // Test if postScore method exists
                if (typeof window.TelegramGameProxy.postScore === 'function') {
                    log('‚úÖ postScore method is available');
                } else {
                    log('‚ùå postScore method not found');
                }
            } else {
                log('‚ùå TelegramGameProxy not loaded');
            }
            
            // Check environment
            log('window.parent === window: ' + (window.parent === window));
            log('URL hash: ' + window.location.hash);
            log('URL search: ' + window.location.search);
            log('User agent: ' + navigator.userAgent);
        }
        
        function testScoreSubmission(score) {
            log(`\n=== Testing Score Submission: ${score} ===`);
            
            if (typeof window.TelegramGameProxy !== 'undefined') {
                log('Using TelegramGameProxy...');
                
                try {
                    if (typeof window.TelegramGameProxy.postScore === 'function') {
                        log(`Calling TelegramGameProxy.postScore(${score})`);
                        window.TelegramGameProxy.postScore(score);
                        log('‚úÖ postScore call completed (no immediate error)');
                        
                        // Wait a moment and check if anything happened
                        setTimeout(() => {
                            log('Checking if score was processed...');
                        }, 1000);
                        
                    } else {
                        log('‚ùå postScore method not available');
                    }
                } catch (error) {
                    log('‚ùå Error calling postScore: ' + error.message);
                }
            } else {
                log('‚ùå TelegramGameProxy not available');
                
                // Try manual postMessage as fallback
                if (window.parent !== window) {
                    log('Trying manual postMessage...');
                    try {
                        window.parent.postMessage({
                            eventType: 'game_score',
                            eventData: JSON.stringify({
                                type: 'game_score',
                                score: score,
                                timestamp: Date.now()
                            })
                        }, '*');
                        log('‚úÖ postMessage sent');
                    } catch (error) {
                        log('‚ùå postMessage error: ' + error.message);
                    }
                } else {
                    log('‚ùå Not in iframe, cannot send postMessage');
                }
            }
        }
        
        // Listen for messages from parent
        window.addEventListener('message', function(event) {
            log('üì® Received message from parent: ' + JSON.stringify(event.data));
        });
        
        // Run initial diagnostics
        window.addEventListener('load', function() {
            log('üöÄ Test page loaded');
            updateStatus('Ready for testing');
            testOfficialAPI();
        });
    </script>
</body>
</html>
